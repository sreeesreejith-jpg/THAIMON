<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Fee Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="fee.png">
    <link rel="apple-touch-icon" href="fee.png">
    <meta name="theme-color" content="#1a2a6c">

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .col {
            flex: 1;
            text-align: left;
        }

        .col label {
            font-size: 0.8rem;
            margin-bottom: 5px;
            display: block;
            color: var(--accent-color);
            font-weight: 700;
        }

        .category-input {
            font-size: 1.2rem !important;
            padding: 10px !important;
            margin-bottom: 0 !important;
        }

        .divider {
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            margin: 25px 0;
            border-radius: 2px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--accent-color);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
        }
    </style>
</head>

<body>
    <div class="container fade-in" style="max-width: 600px;">
        <h1>School Manager</h1>

        <div class="form-group">
            <label for="school-code-input">Secret / School Code <br><small
                    style="opacity: 0.7; font-weight: 400;">(Enter to save online for future use)</small></label>
            <input type="text" id="school-code-input" class="school-name-input" placeholder="Enter Secret Code"
                style="font-size: 1.3rem; margin-bottom: 10px; padding: 10px;">
        </div>

        <div class="form-group">
            <label for="school-name-input">School/User Name</label>
            <input type="text" id="school-name-input" class="school-name-input" placeholder="Name"
                style="font-size: 1.2rem; margin-bottom: 15px; padding: 10px;">
        </div>

        <div class="section-title" style="margin-bottom: 10px; font-size: 1rem;">Student Counts</div>

        <div class="row" style="margin-bottom: 10px;">
            <div class="col">
                <label>SC</label>
                <input type="number" id="sc-students" class="category-input" value="0">
            </div>
            <div class="col">
                <label>ST</label>
                <input type="number" id="st-students" class="category-input" value="0">
            </div>
            <div class="col">
                <label>OEC</label>
                <input type="number" id="oec-students" class="category-input" value="0">
            </div>
        </div>
        <div class="row" style="margin-bottom: 10px;">
            <div class="col" style="flex: 2;">
                <label>General Students</label>
                <input type="number" id="gen-students" class="category-input" value="0">
            </div>
            <div class="col" style="flex: 1;">
                <label>Total</label>
                <input type="number" id="total-students" value="0" readonly
                    style="background: rgba(255,255,255,0.05); color: var(--accent-color); font-weight: bold; font-size: 1.2rem; padding: 10px;">
            </div>
        </div>

        <div class="section-title" style="margin: 15px 0 10px 0; font-size: 1rem;">Fee Calculator</div>

        <div class="form-group">
            <select id="installment-type" style="padding: 10px;">
                <option value="" disabled selected>Choose Fee Type</option>
                <option value="first">First Installment</option>
                <option value="second">Second Installment</option>
                <option value="sslc-card">SSLC Card</option>
                <option value="sslc-fees">SSLC Fees</option>
                <option value="af-ff">Fest & Athletic Fees</option>
            </select>
        </div>

        <div id="calculation-result" style="margin-top: 15px; padding: 15px;">
            <p id="fee-label" style="font-size: 0.9rem;">Estimated Total Fee</p>
            <div class="total-fee-val" style="font-size: 1.8rem;">₹ <span id="total-fee-amount">0.00</span></div>
        </div>

        <div class="links" style="margin-top: 20px; gap: 10px;">
            <button id="show-report" class="btn pdf-btn" disabled
                style="opacity: 0.6; padding: 12px; margin-top: 0;">Show Final Report</button>
            <button id="share-report" class="btn pdf-btn" disabled
                style="opacity: 0.6; padding: 12px; margin-top: 5px;">Share Report</button>
        </div>

        <!-- Hidden Report for Preview - Now larger and clickable to hide -->
        <div id="report-preview" onclick="this.style.display='none'" title="Click to hide">
            <div class="report-header-box">
                <h2 id="report-school-name" style="font-size: 1.4rem;">SCHOOL NAME</h2>
            </div>
            <div class="report-type-box">
                <span id="rep-type-name" style="font-size: 1.1rem;"></span>
            </div>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Students</th>
                        <th>Rate</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="row-sc">
                        <td>SC</td>
                        <td id="rep-sc"></td>
                        <td>0.00</td>
                        <td id="rep-sc-fee"></td>
                    </tr>
                    <tr id="row-st">
                        <td>ST</td>
                        <td id="rep-st"></td>
                        <td>0.00</td>
                        <td id="rep-st-fee"></td>
                    </tr>
                    <tr id="row-oec">
                        <td>OEC</td>
                        <td id="rep-oec"></td>
                        <td>0.00</td>
                        <td id="rep-oec-fee"></td>
                    </tr>
                    <tr id="row-gen">
                        <td>General</td>
                        <td id="rep-gen"></td>
                        <td id="rep-gen-rate">0.00</td>
                        <td id="rep-gen-fee"></td>
                    </tr>
                    <tr class="report-footer-row">
                        <td colspan="3" style="text-align: right; font-size: 1.1rem;">Final Total</td>
                        <td id="rep-fee" style="font-weight: bold; font-size: 1.1rem;"></td>
                    </tr>
                </tbody>
            </table>
            <div class="report-student-count" style="font-size: 1.1rem; padding: 15px;">
                Total Students: <span id="rep-total"></span>
            </div>
            <div style="background: #eee; color: #666; font-size: 0.7rem; padding: 5px;">Click anywhere on report to
                close</div>
        </div>
    </div>

    <script src="capacitor.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURATION & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD6w0IYFllw_woTeuTHgSx9BkgczvmGYo0",
            authDomain: "fees-334ec.firebaseapp.com",
            databaseURL: "https://fees-334ec-default-rtdb.firebaseio.com",
            projectId: "fees-334ec",
            storageBucket: "fees-334ec.firebasestorage.app",
            messagingSenderId: "673058065420",
            appId: "1:673058065420:web:89d33d690c3c01ac417229"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const schoolNameInput = document.getElementById('school-name-input');
        const schoolCodeInput = document.getElementById('school-code-input');
        const scInput = document.getElementById('sc-students');
        const stInput = document.getElementById('st-students');
        const oecInput = document.getElementById('oec-students');
        const genInput = document.getElementById('gen-students');
        const totalInput = document.getElementById('total-students');
        const typeSelect = document.getElementById('installment-type');
        const totalFeeAmount = document.getElementById('total-fee-amount');
        const showBtn = document.getElementById('show-report');
        const shareBtn = document.getElementById('share-report');
        const reportSchoolName = document.getElementById('report-school-name');
        const previewEl = document.getElementById('report-preview');

        let syncTimeout;

        // --- CORE LOGIC ---

        const calculateFees = () => {
            const sc = parseInt(scInput.value) || 0;
            const st = parseInt(stInput.value) || 0;
            const oec = parseInt(oecInput.value) || 0;
            const gen = parseInt(genInput.value) || 0;
            const total = sc + st + oec + gen;
            totalInput.value = total;

            const type = typeSelect.value;
            let scRate = 0, stRate = 0, oecRate = 0, genRate = 0;

            if (type === 'sslc-card') { genRate = 15; oecRate = 15; }
            else if (type === 'sslc-fees') { genRate = 30; }
            else if (type === 'af-ff') { genRate = 17; oecRate = 17; }
            else if (type === 'first' || type === 'second') { genRate = 12.50; }

            const totalFee = (sc * scRate) + (st * stRate) + (oec * oecRate) + (gen * genRate);
            totalFeeAmount.textContent = totalFee.toFixed(2);

            // Update Preview
            if (type) {
                document.getElementById('rep-type-name').textContent = typeSelect.options[typeSelect.selectedIndex].text;
                document.getElementById('rep-total').textContent = total;
                document.getElementById('rep-sc').textContent = sc;
                document.getElementById('rep-sc-fee').textContent = (sc * scRate).toFixed(2);
                document.getElementById('row-sc').style.display = sc > 0 ? '' : 'none';
                document.getElementById('rep-st').textContent = st;
                document.getElementById('rep-st-fee').textContent = (st * stRate).toFixed(2);
                document.getElementById('row-st').style.display = st > 0 ? '' : 'none';
                document.getElementById('rep-oec').textContent = oec;
                document.getElementById('rep-oec-fee').textContent = (oec * oecRate).toFixed(2);
                document.getElementById('row-oec').style.display = oec > 0 ? '' : 'none';
                document.getElementById('rep-gen').textContent = gen;
                document.getElementById('rep-gen-rate').textContent = genRate.toFixed(2);
                document.getElementById('rep-gen-fee').textContent = (gen * genRate).toFixed(2);
                document.getElementById('row-gen').style.display = gen > 0 ? '' : 'none';
                document.getElementById('rep-fee').textContent = totalFee.toFixed(2);

                showBtn.disabled = total === 0;
                showBtn.style.opacity = total === 0 ? "0.6" : "1";
                shareBtn.disabled = total === 0;
                shareBtn.style.opacity = total === 0 ? "0.6" : "1";
            }
        };

        const autoSyncToCloud = () => {
            const code = schoolCodeInput.value.trim();
            const name = schoolNameInput.value.trim();

            // Local storage ALWAYS works
            localStorage.setItem('schoolName', name);
            localStorage.setItem('schoolCode', code);
            reportSchoolName.textContent = name.toUpperCase() || 'NAME';

            // Cloud sync ONLY if a code is provided
            if (!code) {
                console.log("No secret code. Data stored locally only.");
                return;
            }

            const schoolKey = `code_${code.toLowerCase().replace(/\s+/g, '_')}`;
            const dbPath = `school_defaults/${schoolKey}`;
            const localKey = `fee_defaults_${schoolKey}`;

            const data = {
                name: name,
                sc: scInput.value,
                st: stInput.value,
                oec: oecInput.value,
                gen: genInput.value,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };

            localStorage.setItem(localKey, JSON.stringify(data));

            clearTimeout(syncTimeout);
            syncTimeout = setTimeout(() => {
                database.ref(dbPath).set(data)
                    .then(() => console.log("✓ Cloud sync successful for code:", code))
                    .catch(e => console.error("Cloud sync failed", e));
            }, 800);
        };

        // --- EVENT LISTENERS ---

        schoolCodeInput.addEventListener('input', (e) => {
            const code = e.target.value.trim();
            localStorage.setItem('schoolCode', code);

            if (code.length >= 2) {
                const dbPath = `school_defaults/code_${code.toLowerCase().replace(/\s+/g, '_')}`;
                database.ref(dbPath).once('value').then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        schoolNameInput.value = data.name || '';
                        scInput.value = data.sc || 0;
                        stInput.value = data.st || 0;
                        oecInput.value = data.oec || 0;
                        genInput.value = data.gen || 0;
                        reportSchoolName.textContent = (data.name || '').toUpperCase();
                        calculateFees();
                    }
                });
            }
        });

        [schoolNameInput, scInput, stInput, oecInput, genInput].forEach(input => {
            input.addEventListener('input', () => {
                autoSyncToCloud();
                calculateFees();
            });
        });

        typeSelect.addEventListener('change', calculateFees);

        showBtn.addEventListener('click', () => {
            previewEl.style.display = 'block';
            previewEl.scrollIntoView({ behavior: 'smooth' });
        });

        shareBtn.addEventListener('click', async () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const schoolName = schoolNameInput.value || "School";
                const typeName = typeSelect.options[typeSelect.selectedIndex].text;

                const sc = parseInt(scInput.value) || 0;
                const st = parseInt(stInput.value) || 0;
                const oec = parseInt(oecInput.value) || 0;
                const gen = parseInt(genInput.value) || 0;

                let scRate = 0, stRate = 0, oecRate = 0, genRate = 0;
                const type = typeSelect.value;
                if (type === 'sslc-card') { genRate = 15; oecRate = 15; }
                else if (type === 'sslc-fees') { genRate = 30; }
                else if (type === 'af-ff') { genRate = 17; oecRate = 17; }
                else if (type === 'first' || type === 'second') { genRate = 12.50; }

                const rows = [];
                if (sc > 0) rows.push(["SC", sc, scRate.toFixed(2), (sc * scRate).toFixed(2)]);
                if (st > 0) rows.push(["ST", st, stRate.toFixed(2), (st * stRate).toFixed(2)]);
                if (oec > 0) rows.push(["OEC", oec, oecRate.toFixed(2), (oec * oecRate).toFixed(2)]);
                if (gen > 0) rows.push(["General", gen, genRate.toFixed(2), (gen * genRate).toFixed(2)]);
                const totalFee = (sc * scRate) + (st * stRate) + (oec * oecRate) + (gen * genRate);

                // PDF DESIGN
                const primaryColor = [26, 42, 108];
                doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setFontSize(22);
                doc.setFont("helvetica", "bold");
                doc.text(schoolName.toUpperCase(), 105, 25, { align: 'center' });
                doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                doc.setLineWidth(1);
                doc.line(20, 30, 190, 30);
                doc.setFontSize(16);
                doc.setTextColor(178, 31, 31);
                doc.text(typeName.toUpperCase(), 105, 45, { align: 'center' });
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 15, 55);

                doc.autoTable({
                    startY: 65,
                    head: [['Category', 'No. of Students', 'Rate (Rs.)', 'Total (Rs.)']],
                    body: rows,
                    foot: [['', '', 'Final Total Fee', `Rs. ${totalFee.toFixed(2)}`]],
                    theme: 'striped',
                    headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold', halign: 'center' },
                    footStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold', halign: 'right' },
                    styles: { fontSize: 11, cellPadding: 5 },
                    columnStyles: { 1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'right' } }
                });

                const finalY = doc.lastAutoTable.finalY + 15;
                doc.setFont("helvetica", "bold");
                doc.text(`Total Number of Students: ${sc + st + oec + gen}`, 15, finalY);

                const fileName = `Fee_Report_${Date.now()}.pdf`;

                if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                    const { Share, Filesystem } = window.Capacitor.Plugins;
                    const pdfBase64 = doc.output('datauristring').split(',')[1];
                    const result = await Filesystem.writeFile({ path: fileName, data: pdfBase64, directory: 'CACHE' });
                    await Share.share({ title: 'Fee Report', text: `Fee report for ${typeName}`, url: result.uri, dialogTitle: 'Share Report' });
                } else {
                    doc.save(fileName);
                }
            } catch (err) {
                alert("Report Error: " + err.message);
            }
        });

        // Initialize state
        const savedCode = localStorage.getItem('schoolCode');
        if (savedCode) {
            schoolCodeInput.value = savedCode;
            const schoolKey = `code_${savedCode.toLowerCase().replace(/\s+/g, '_')}`;
            const localData = localStorage.getItem(`fee_defaults_${schoolKey}`);
            if (localData) {
                const data = JSON.parse(localData);
                schoolNameInput.value = data.name || '';
                scInput.value = data.sc || 0;
                stInput.value = data.st || 0;
                oecInput.value = data.oec || 0;
                genInput.value = data.gen || 0;
                reportSchoolName.textContent = (data.name || '').toUpperCase();
                calculateFees();
            }
        }

        // Handle Back Button
        if (window.Capacitor && window.Capacitor.isNativePlatform()) {
            const { App } = window.Capacitor.Plugins;
            if (App) App.addListener('backButton', () => App.exitApp());
        }
    </script>
</body>

</html>