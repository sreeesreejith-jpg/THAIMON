<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Calculator</title>
    <link rel="stylesheet" href="style.css">
    <!-- jsPDF Library in Head for faster loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Awesome for Home Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="fee.png">
    <link rel="apple-touch-icon" href="fee.png">
    <meta name="theme-color" content="#1a2a6c">
</head>

<body>
    <div class="container">
        <div class="top-nav">
            <a href="index.html" class="home-icon" title="Go to Home"><i class="fas fa-home"></i></a>
        </div>
        <h1>Fee Calculator</h1>

        <div class="form-group">
            <label for="installment-type">Select Type</label>
            <select id="installment-type">
                <option value="" disabled selected>Choose an option</option>
                <option value="first">First Installment</option>
                <option value="second">Second Installment</option>
                <option value="sslc-card">SSLC Card</option>
                <option value="sslc-fees">SSLC Fees</option>
                <option value="af-ff">AF/ff</option>
            </select>
        </div>

        <div id="first-installment-fields" class="hidden">
            <div class="form-group">
                <label>No of SC Students</label>
                <input type="number" id="sc-students" value="0">
            </div>
            <div class="form-group">
                <label>No of ST Students</label>
                <input type="number" id="st-students" value="0">
            </div>
            <div class="form-group">
                <label>No of OEC Students</label>
                <input type="number" id="oec-students" value="0">
            </div>
            <div class="form-group">
                <label>No of General Students</label>
                <input type="number" id="gen-students" value="0">
            </div>
            <div class="form-group">
                <label>Total No of Students</label>
                <input type="number" id="total-students" value="0" readonly
                    style="background: rgba(255, 255, 255, 0.1); cursor: not-allowed;">
            </div>

            <div id="calculation-result">
                <p id="fee-label">Total Fees</p>
                <div class="total-fee-val"><span id="currency-symbol">â‚¹</span> <span id="total-fee-amount">0.00</span>
                </div>
            </div>

            <button id="show-report" class="btn pdf-btn">Show Final Report</button>
            <button id="share-report" class="btn pdf-btn">Share Report</button>

            <!-- Hidden Report for Printing and Preview -->
            <div id="report-preview">
                <div class="report-header-box">
                    <h2 id="report-school-name">GVHSS THRIKKOTHAMANGALAM</h2>
                </div>
                <div class="report-type-box">
                    <span id="rep-type-name"></span>
                </div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>No. of Students</th>
                            <th>Rate</th>
                            <th>Total Fee</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="row-sc">
                            <td>SC</td>
                            <td id="rep-sc"></td>
                            <td>0.00</td>
                            <td id="rep-sc-fee"></td>
                        </tr>
                        <tr id="row-st">
                            <td>ST</td>
                            <td id="rep-st"></td>
                            <td>0.00</td>
                            <td id="rep-st-fee"></td>
                        </tr>
                        <tr id="row-oec">
                            <td>OEC</td>
                            <td id="rep-oec"></td>
                            <td>0.00</td>
                            <td id="rep-oec-fee"></td>
                        </tr>
                        <tr id="row-gen">
                            <td>General</td>
                            <td id="rep-gen"></td>
                            <td id="rep-gen-rate">12.00</td>
                            <td id="rep-gen-fee"></td>
                        </tr>
                        <tr class="report-footer-row">
                            <td colspan="3" style="text-align: right;">Final Total Fees</td>
                            <td id="rep-fee" style="font-weight: bold;"></td>
                        </tr>
                    </tbody>
                </table>
                <div class="report-student-count">
                    Total No of Students: <span id="rep-total"></span>
                </div>
            </div>
        </div>

        <!-- Capacitor JavaScript (if running as an app) -->
        <script src="capacitor.js"></script>
        <script>
            const typeSelect = document.getElementById('installment-type');
            const firstFields = document.getElementById('first-installment-fields');
            const genStudentsInput = document.getElementById('gen-students');
            const totalFeeDisplay = document.getElementById('total-fee-amount');
            const showBtn = document.getElementById('show-report');
            const shareBtn = document.getElementById('share-report');
            const previewEl = document.getElementById('report-preview');
            const reportSchoolName = document.getElementById('report-school-name');

            // Load School Name
            const savedSchoolName = localStorage.getItem('schoolName') || 'GVHSS Thrikkothamangalam';
            document.title = `Fee Calculator - ${savedSchoolName}`;
            reportSchoolName.textContent = savedSchoolName.toUpperCase();

            // Show/Hide fields
            typeSelect.addEventListener('change', () => {
                if (typeSelect.value) {
                    firstFields.classList.remove('hidden');
                    // Reset all inputs to 0 on change
                    document.getElementById('total-students').value = "0";
                    document.getElementById('sc-students').value = "0";
                    document.getElementById('st-students').value = "0";
                    document.getElementById('oec-students').value = "0";
                    document.getElementById('gen-students').value = "0";
                } else {
                    firstFields.classList.add('hidden');
                }
                previewEl.style.display = 'none';
                calculateFees();
            });

            // Calculate Fees
            const calculateFees = () => {
                const totalCountInput = document.getElementById('total-students');
                const scCountInput = document.getElementById('sc-students');
                const stCountInput = document.getElementById('st-students');
                const oecCountInput = document.getElementById('oec-students');
                const genCountInput = document.getElementById('gen-students');

                const scCount = parseInt(scCountInput.value) || 0;
                const stCount = parseInt(stCountInput.value) || 0;
                const oecCount = parseInt(oecCountInput.value) || 0;
                const genCount = parseInt(genCountInput.value) || 0;

                // Sync Total Count
                const totalCount = scCount + stCount + oecCount + genCount;
                totalCountInput.value = totalCount;

                const currencySymbol = document.getElementById('currency-symbol');
                const feeLabel = document.getElementById('fee-label');

                let fee = 0;
                const type = typeSelect.value;
                let scRate = 0, stRate = 0, oecRate = 0, genRate = 0;

                if (type === 'sslc-card') {
                    scRate = stRate = oecRate = genRate = 15;
                } else if (type === 'sslc-fees') {
                    scRate = stRate = oecRate = genRate = 30;
                } else if (type === 'af-ff') {
                    scRate = stRate = oecRate = genRate = 17;
                } else {
                    scRate = stRate = oecRate = genRate = 12; // Default rate for installments
                }

                fee = (scCount * scRate) + (stCount * stRate) + (oecCount * oecRate) + (genCount * genRate);

                totalFeeDisplay.textContent = fee.toFixed(2);

                // Update Preview Data Dynamically
                if (type) {
                    document.getElementById('rep-type-name').textContent = typeSelect.options[typeSelect.selectedIndex].text;
                    document.getElementById('rep-total').textContent = totalCount;

                    document.getElementById('rep-sc').textContent = scCount;
                    document.getElementById('rep-sc-fee').textContent = (scCount * scRate).toFixed(2);
                    document.getElementById('row-sc').style.display = scCount > 0 ? '' : 'none';

                    document.getElementById('rep-st').textContent = stCount;
                    document.getElementById('rep-st-fee').textContent = (stCount * stRate).toFixed(2);
                    document.getElementById('row-st').style.display = stCount > 0 ? '' : 'none';

                    document.getElementById('rep-oec').textContent = oecCount;
                    document.getElementById('rep-oec-fee').textContent = (oecCount * oecRate).toFixed(2);
                    document.getElementById('row-oec').style.display = oecCount > 0 ? '' : 'none';

                    document.getElementById('rep-gen').textContent = genCount;
                    document.getElementById('rep-gen-fee').textContent = (genCount * genRate).toFixed(2);
                    document.getElementById('rep-gen-rate').textContent = genRate.toFixed(2);
                    document.getElementById('row-gen').style.display = genCount > 0 ? '' : 'none';

                    document.getElementById('rep-fee').textContent = fee.toFixed(2);
                }

                if (totalCount === 0) {
                    showBtn.disabled = true;
                    showBtn.style.opacity = "0.6";
                    shareBtn.disabled = true;
                    shareBtn.style.opacity = "0.6";
                } else {
                    showBtn.disabled = false;
                    showBtn.style.opacity = "1";
                    shareBtn.disabled = false;
                    shareBtn.style.opacity = "1";
                }
            };

            // Hardware Back Button Integration
            if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                const { App } = window.Capacitor.Plugins;
                if (App) {
                    App.addListener('backButton', () => {
                        window.location.href = 'index.html';
                    });
                }
            }

            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => input.addEventListener('input', calculateFees));

            // SHOW REPORT Logic
            showBtn.addEventListener('click', () => {
                // Show Preview
                previewEl.style.display = 'block';
                previewEl.scrollIntoView({ behavior: 'smooth' });
            });

            // PDF Generation and Sharing
            shareBtn.addEventListener('click', async () => {
                console.log("Share button clicked");
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const primaryColor = [26, 42, 108]; // Dark blue #1a2a6c

                    const type = typeSelect.value;
                    const typeName = typeSelect.options[typeSelect.selectedIndex].text;
                    const totalStudents = document.getElementById('total-students').value || "0";

                    const scCount = parseFloat(document.getElementById('sc-students').value) || 0;
                    const stCount = parseFloat(document.getElementById('st-students').value) || 0;
                    const oecCount = parseFloat(document.getElementById('oec-students').value) || 0;
                    const genCount = parseFloat(genStudentsInput.value) || 0;

                    let scRate = 0, stRate = 0, oecRate = 0, genRate = 0;

                    if (type === 'sslc-card') {
                        scRate = stRate = oecRate = genRate = 15;
                    } else if (type === 'sslc-fees') {
                        scRate = stRate = oecRate = genRate = 30;
                    } else if (type === 'af-ff') {
                        scRate = stRate = oecRate = genRate = 17;
                    } else {
                        scRate = stRate = oecRate = genRate = 12;
                    }

                    // Build Table Rows (Only > 0)
                    const rows = [];
                    if (scCount > 0) rows.push(["SC", scCount, scRate.toFixed(2), (scCount * scRate).toFixed(2)]);
                    if (stCount > 0) rows.push(["ST", stCount, stRate.toFixed(2), (stCount * stRate).toFixed(2)]);
                    if (oecCount > 0) rows.push(["OEC", oecCount, oecRate.toFixed(2), (oecCount * oecRate).toFixed(2)]);
                    if (genCount > 0) rows.push(["General", genCount, genRate.toFixed(2), (genCount * genRate).toFixed(2)]);

                    const totalFee = (scCount * scRate) + (stCount * stRate) + (oecCount * oecRate) + (genCount * genRate);

                    console.log("Generating PDF content...");
                    // Add School Name and Title to PDF
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.text(savedSchoolName.toUpperCase(), 105, 25, { align: 'center' });

                    doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.setLineWidth(1);
                    doc.line(20, 30, 190, 30);

                    doc.setFontSize(16);
                    doc.setTextColor(178, 31, 31); // Reddish color for type
                    doc.text(typeName.toUpperCase(), 105, 45, { align: 'center' });

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.text(`Date: ${new Date().toLocaleDateString()}`, 15, 55);

                    // Generate Table
                    doc.autoTable({
                        startY: 65,
                        head: [['Category', 'No. of Students', 'Rate (Rs.)', 'Total (Rs.)']],
                        body: rows,
                        foot: [['', '', 'Final Total Fee', `Rs. ${totalFee.toFixed(2)}`]],
                        theme: 'striped',
                        headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold', halign: 'center' },
                        footStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold', halign: 'right' },
                        styles: { fontSize: 11, cellPadding: 5 },
                        columnStyles: {
                            1: { halign: 'right' },
                            2: { halign: 'right' },
                            3: { halign: 'right' }
                        }
                    });

                    // Student Count Summary moved under table
                    const finalY = doc.lastAutoTable.finalY + 15;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Total Number of Students: ${totalStudents}`, 15, finalY);

                    const fileName = `Fee_Report_${Date.now()}.pdf`;
                    console.log("PDF generated, preparing share...");

                    // Check for Capacitor Native Plugins first
                    if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                        console.log("Running in Native Platform");
                        const { Share, Filesystem } = window.Capacitor.Plugins;

                        if (Share && Filesystem) {
                            try {
                                const pdfBase64 = doc.output('datauristring').split(',')[1];
                                const result = await Filesystem.writeFile({
                                    path: fileName,
                                    data: pdfBase64,
                                    directory: 'CACHE'
                                });
                                console.log("File written to cache: " + result.uri);

                                await Share.share({
                                    title: 'Fee Calculation Report',
                                    text: `Fee report for ${typeName}`,
                                    url: result.uri,
                                    dialogTitle: 'Share Report'
                                });
                                console.log("Native share triggered");
                                return;
                            } catch (err) {
                                console.error("Native share failed:", err);
                                // Continue to web fallback
                            }
                        }
                    }

                    // Web and Fallback Share Logic
                    console.log("Using Web/Browser share fallback");
                    const pdfBlob = doc.output('blob');
                    const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                        await navigator.share({
                            files: [pdfFile],
                            title: 'Fee Calculation Report',
                            text: `Fee report for ${typeName}`
                        });
                    } else {
                        console.log("Navigator share not available, opening print/tab");
                        const pdfDataUri = doc.output('datauristring');
                        const newWindow = window.open(pdfDataUri, '_blank');
                        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                            alert("Sharing not supported. Attempting to bring up Print dialog...");
                            window.print();
                        }
                    }
                } catch (err) {
                    console.error("Critical PDF failure:", err);
                    alert("Report Error: " + err.message);
                }
            });
        </script>

</body>

</html>