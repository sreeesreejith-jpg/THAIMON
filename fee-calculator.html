<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Calculator</title>
    <link rel="stylesheet" href="style.css">
    <!-- jsPDF Library in Head for faster loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Awesome for Home Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs (Compat Version for easier learning) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="fee.png">
    <link rel="apple-touch-icon" href="fee.png">
    <meta name="theme-color" content="#1a2a6c">
</head>

<body>
    <div class="container">
        <div class="top-nav">
            <a href="index.html" class="home-icon" title="Go to Home"><i class="fas fa-home"></i></a>
        </div>
        <h1>Fee Calculator</h1>

        <div class="form-group">
            <label for="installment-type">Select Type</label>
            <select id="installment-type">
                <option value="" disabled selected>Choose an option</option>
                <option value="first">First Installment</option>
                <option value="second">Second Installment</option>
                <option value="sslc-card">SSLC Card</option>
                <option value="sslc-fees">SSLC Fees</option>
                <option value="af-ff">Fest & Athletic Fees</option>
            </select>
        </div>

        <div id="first-installment-fields" class="hidden">
            <div class="form-group">
                <label>No of SC Students</label>
                <input type="number" id="sc-students" value="0">
            </div>
            <div class="form-group">
                <label>No of ST Students</label>
                <input type="number" id="st-students" value="0">
            </div>
            <div class="form-group">
                <label>No of OEC Students</label>
                <input type="number" id="oec-students" value="0">
            </div>
            <div class="form-group">
                <label>No of General Students</label>
                <input type="number" id="gen-students" value="0">
            </div>
            <div class="form-group">
                <label>Total No of Students</label>
                <input type="number" id="total-students" value="0" readonly
                    style="background: rgba(255, 255, 255, 0.1); cursor: not-allowed;">
            </div>

            <div id="calculation-result">
                <p id="fee-label">Total Fees</p>
                <div class="total-fee-val"><span id="currency-symbol">â‚¹</span> <span id="total-fee-amount">0.00</span>
                </div>
            </div>

            <button id="show-report" class="btn pdf-btn">Show Final Report</button>
            <button id="share-report" class="btn pdf-btn">Share Report</button>

            <!-- Hidden Report for Printing and Preview -->
            <div id="report-preview">
                <div class="report-header-box">
                    <h2 id="report-school-name">GVHSS THRIKKOTHAMANGALAM</h2>
                </div>
                <div class="report-type-box">
                    <span id="rep-type-name"></span>
                </div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>No. of Students</th>
                            <th>Rate</th>
                            <th>Total Fee</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="row-sc">
                            <td>SC</td>
                            <td id="rep-sc"></td>
                            <td>0.00</td>
                            <td id="rep-sc-fee"></td>
                        </tr>
                        <tr id="row-st">
                            <td>ST</td>
                            <td id="rep-st"></td>
                            <td>0.00</td>
                            <td id="rep-st-fee"></td>
                        </tr>
                        <tr id="row-oec">
                            <td>OEC</td>
                            <td id="rep-oec"></td>
                            <td>0.00</td>
                            <td id="rep-oec-fee"></td>
                        </tr>
                        <tr id="row-gen">
                            <td>General</td>
                            <td id="rep-gen"></td>
                            <td id="rep-gen-rate">12.50</td>
                            <td id="rep-gen-fee"></td>
                        </tr>
                        <tr class="report-footer-row">
                            <td colspan="3" style="text-align: right;">Final Total Fees</td>
                            <td id="rep-fee" style="font-weight: bold;"></td>
                        </tr>
                    </tbody>
                </table>
                <div class="report-student-count">
                    Total No of Students: <span id="rep-total"></span>
                </div>
            </div>
        </div>

        <!-- Capacitor JavaScript (if running as an app) -->
        <script src="capacitor.js"></script>
        <script>
            const typeSelect = document.getElementById('installment-type');
            const firstFields = document.getElementById('first-installment-fields');
            const genStudentsInput = document.getElementById('gen-students');
            const totalFeeDisplay = document.getElementById('total-fee-amount');
            const showBtn = document.getElementById('show-report');
            const shareBtn = document.getElementById('share-report');
            const previewEl = document.getElementById('report-preview');
            const reportSchoolName = document.getElementById('report-school-name');

            let syncTimeout;

            // --- FIREBASE CONFIGURATION ---
            // Replace the values below with your own from the Firebase Console
            const firebaseConfig = {
                apiKey: "AIzaSyD6w0IYFllw_woTeuTHgSx9BkgczvmGYo0",
                authDomain: "fees-334ec.firebaseapp.com",
                databaseURL: "https://fees-334ec-default-rtdb.firebaseio.com",
                projectId: "fees-334ec",
                storageBucket: "fees-334ec.firebasestorage.app",
                messagingSenderId: "673058065420",
                appId: "1:673058065420:web:89d33d690c3c01ac417229"
            };

            // Initialize Firebase
            // This starts the connection to Google's servers
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
            } catch (err) {
                console.error("Firebase initialization failed:", err);
            }
            const database = firebase.database();

            // Load School Name and Code
            const savedSchoolName = localStorage.getItem('schoolName') || 'GVHSS Thrikkothamangalam';
            const savedSchoolCode = localStorage.getItem('schoolCode') || '00000';

            document.title = `Fee Calculator - ${savedSchoolName}`;
            reportSchoolName.textContent = savedSchoolName.toUpperCase();

            // Helper to clean school name/code for database path
            const getDbPath = () => {
                if (!savedSchoolCode || savedSchoolCode === '00000') {
                    // Fallback to name if code is missing, but warn
                    console.warn("School Code missing, using name-based path.");
                    return `school_defaults/${savedSchoolName.toLowerCase().replace(/\s+/g, '_')}`;
                }
                return `school_defaults/code_${savedSchoolCode.toLowerCase().replace(/\s+/g, '_')}`;
            };

            // Load Defaults helper (Now with Firebase!)
            const loadSavedDefaults = async (isAuto = false) => {
                const dbPath = getDbPath();
                const schoolKey = (savedSchoolCode && savedSchoolCode !== '00000') ?
                    `code_${savedSchoolCode.toLowerCase().replace(/\s+/g, '_')}` :
                    savedSchoolName.toLowerCase().replace(/\s+/g, '_');

                // 1. Try to load from Local Storage first (for speed/offline)
                const localKey = `fee_defaults_${schoolKey}`;
                const localData = localStorage.getItem(localKey);
                if (localData) {
                    const data = JSON.parse(localData);
                    applyDataToInputs(data);
                }

                // 2. Sync with Firebase in the background
                try {
                    console.log("Fetching from Firebase for path:", dbPath);
                    const snapshot = await database.ref(dbPath).once('value');
                    if (snapshot.exists()) {
                        const cloudData = snapshot.val();
                        applyDataToInputs(cloudData);

                        // Update local cache
                        localStorage.setItem(localKey, JSON.stringify(cloudData));
                        if (!isAuto) alert("Data synced from Cloud!");
                        return true;
                    }
                } catch (err) {
                    console.error("Firebase load failed:", err);
                    if (!isAuto && !localData) alert("No data found (Offline or not set).");
                }
                return !!localData;
            };

            const applyDataToInputs = (data) => {
                document.getElementById('sc-students').value = data.sc || 0;
                document.getElementById('st-students').value = data.st || 0;
                document.getElementById('oec-students').value = data.oec || 0;
                document.getElementById('gen-students').value = data.gen || 0;
            };

            // Show/Hide fields
            typeSelect.addEventListener('change', async () => {
                if (typeSelect.value) {
                    firstFields.classList.remove('hidden');
                    // Try to load defaults automatically
                    await loadSavedDefaults(true);
                } else {
                    firstFields.classList.add('hidden');
                }
                previewEl.style.display = 'none';
                calculateFees();
            });

            // ðŸ”„ Real-time Auto-Sync Logic for Calculator
            const autoSyncToCloud = () => {
                const code = savedSchoolCode;
                if (!code || code === '00000') return;

                const dbPath = getDbPath();
                const schoolKey = `code_${code.toLowerCase().replace(/\s+/g, '_')}`;
                const localKey = `fee_defaults_${schoolKey}`;

                const data = {
                    name: savedSchoolName,
                    sc: document.getElementById('sc-students').value,
                    st: document.getElementById('st-students').value,
                    oec: document.getElementById('oec-students').value,
                    gen: document.getElementById('gen-students').value,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                };

                // Save locally instantly
                localStorage.setItem(localKey, JSON.stringify(data));

                // Sync to Firebase (Debounced)
                clearTimeout(syncTimeout);
                syncTimeout = setTimeout(() => {
                    database.ref(dbPath).set(data)
                        .then(() => console.log("âœ“ Calculator: Cloud sync successful"))
                        .catch(e => console.error("âœ— Calculator: Cloud sync failed", e));
                }, 800);
            };

            // Attach auto-sync to student count inputs
            ['sc-students', 'st-students', 'oec-students', 'gen-students'].forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('input', () => {
                    calculateFees(); // Update the fee calculation
                    autoSyncToCloud(); // Sync to cloud
                });
            });

            // Calculate Fees
            const calculateFees = () => {
                const totalCountInput = document.getElementById('total-students');
                const scCountInput = document.getElementById('sc-students');
                const stCountInput = document.getElementById('st-students');
                const oecCountInput = document.getElementById('oec-students');
                const genCountInput = document.getElementById('gen-students');

                const scCount = parseInt(scCountInput.value) || 0;
                const stCount = parseInt(stCountInput.value) || 0;
                const oecCount = parseInt(oecCountInput.value) || 0;
                const genCount = parseInt(genCountInput.value) || 0;

                // Sync Total Count
                const totalCount = scCount + stCount + oecCount + genCount;
                totalCountInput.value = totalCount;

                const currencySymbol = document.getElementById('currency-symbol');
                const feeLabel = document.getElementById('fee-label');

                let fee = 0;
                const type = typeSelect.value;
                let scRate = 0, stRate = 0, oecRate = 0, genRate = 0;

                if (type === 'sslc-card') {
                    genRate = 15; oecRate = 15; scRate = 0; stRate = 0;
                } else if (type === 'sslc-fees') {
                    genRate = 30; scRate = 0; stRate = 0; oecRate = 0;
                } else if (type === 'af-ff') {
                    genRate = 17; oecRate = 17; scRate = 0; stRate = 0;
                } else {
                    genRate = 12.50; scRate = 0; stRate = 0; oecRate = 0;
                }

                fee = (scCount * scRate) + (stCount * stRate) + (oecCount * oecRate) + (genCount * genRate);

                totalFeeDisplay.textContent = fee.toFixed(2);

                // Update Preview Data Dynamically
                if (type) {
                    document.getElementById('rep-type-name').textContent = typeSelect.options[typeSelect.selectedIndex].text;
                    document.getElementById('rep-total').textContent = totalCount;

                    document.getElementById('rep-sc').textContent = scCount;
                    document.getElementById('rep-sc-fee').textContent = (scCount * scRate).toFixed(2);
                    document.getElementById('row-sc').style.display = scCount > 0 ? '' : 'none';

                    document.getElementById('rep-st').textContent = stCount;
                    document.getElementById('rep-st-fee').textContent = (stCount * stRate).toFixed(2);
                    document.getElementById('row-st').style.display = stCount > 0 ? '' : 'none';

                    document.getElementById('rep-oec').textContent = oecCount;
                    document.getElementById('rep-oec-fee').textContent = (oecCount * oecRate).toFixed(2);
                    document.getElementById('row-oec').style.display = oecCount > 0 ? '' : 'none';

                    document.getElementById('rep-gen').textContent = genCount;
                    document.getElementById('rep-gen-fee').textContent = (genCount * genRate).toFixed(2);
                    document.getElementById('rep-gen-rate').textContent = genRate.toFixed(2);
                    document.getElementById('row-gen').style.display = genCount > 0 ? '' : 'none';

                    document.getElementById('rep-fee').textContent = fee.toFixed(2);
                }

                if (totalCount === 0) {
                    showBtn.disabled = true;
                    showBtn.style.opacity = "0.6";
                    shareBtn.disabled = true;
                    shareBtn.style.opacity = "0.6";
                } else {
                    showBtn.disabled = false;
                    showBtn.style.opacity = "1";
                    shareBtn.disabled = false;
                    shareBtn.style.opacity = "1";
                }
            };

            // Hardware Back Button Integration
            if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                const { App } = window.Capacitor.Plugins;
                if (App) {
                    App.addListener('backButton', () => {
                        window.location.href = 'index.html';
                    });
                }
            }

            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => input.addEventListener('input', calculateFees));


            // SHOW REPORT Logic
            showBtn.addEventListener('click', () => {
                // Show Preview
                previewEl.style.display = 'block';
                previewEl.scrollIntoView({ behavior: 'smooth' });
            });

            // PDF Generation and Sharing
            shareBtn.addEventListener('click', async () => {
                console.log("Share button clicked");
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const primaryColor = [26, 42, 108]; // Dark blue #1a2a6c

                    const type = typeSelect.value;
                    const typeName = typeSelect.options[typeSelect.selectedIndex].text;
                    const totalStudents = document.getElementById('total-students').value || "0";

                    const scCount = parseFloat(document.getElementById('sc-students').value) || 0;
                    const stCount = parseFloat(document.getElementById('st-students').value) || 0;
                    const oecCount = parseFloat(document.getElementById('oec-students').value) || 0;
                    const genCount = parseFloat(genStudentsInput.value) || 0;

                    let scRate = 0, stRate = 0, oecRate = 0, genRate = 0;

                    if (type === 'sslc-card') {
                        genRate = 15; oecRate = 15; scRate = 0; stRate = 0;
                    } else if (type === 'sslc-fees') {
                        genRate = 30; scRate = 0; stRate = 0; oecRate = 0;
                    } else if (type === 'af-ff') {
                        genRate = 17; oecRate = 17; scRate = 0; stRate = 0;
                    } else {
                        genRate = 12.50; scRate = 0; stRate = 0; oecRate = 0;
                    }

                    // Build Table Rows (Only > 0)
                    const rows = [];
                    if (scCount > 0) rows.push(["SC", scCount, scRate.toFixed(2), (scCount * scRate).toFixed(2)]);
                    if (stCount > 0) rows.push(["ST", stCount, stRate.toFixed(2), (stCount * stRate).toFixed(2)]);
                    if (oecCount > 0) rows.push(["OEC", oecCount, oecRate.toFixed(2), (oecCount * oecRate).toFixed(2)]);
                    if (genCount > 0) rows.push(["General", genCount, genRate.toFixed(2), (genCount * genRate).toFixed(2)]);

                    const totalFee = (scCount * scRate) + (stCount * stRate) + (oecCount * oecRate) + (genCount * genRate);

                    console.log("Generating PDF content...");
                    // Add School Name and Title to PDF
                    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    doc.text(savedSchoolName.toUpperCase(), 105, 25, { align: 'center' });

                    doc.setDrawColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.setLineWidth(1);
                    doc.line(20, 30, 190, 30);

                    doc.setFontSize(16);
                    doc.setTextColor(178, 31, 31); // Reddish color for type
                    doc.text(typeName.toUpperCase(), 105, 45, { align: 'center' });

                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.text(`Date: ${new Date().toLocaleDateString()}`, 15, 55);

                    // Generate Table
                    doc.autoTable({
                        startY: 65,
                        head: [['Category', 'No. of Students', 'Rate (Rs.)', 'Total (Rs.)']],
                        body: rows,
                        foot: [['', '', 'Final Total Fee', `Rs. ${totalFee.toFixed(2)}`]],
                        theme: 'striped',
                        headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold', halign: 'center' },
                        footStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold', halign: 'right' },
                        styles: { fontSize: 11, cellPadding: 5 },
                        columnStyles: {
                            1: { halign: 'right' },
                            2: { halign: 'right' },
                            3: { halign: 'right' }
                        }
                    });

                    // Student Count Summary moved under table
                    const finalY = doc.lastAutoTable.finalY + 15;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Total Number of Students: ${totalStudents}`, 15, finalY);

                    const fileName = `Fee_Report_${Date.now()}.pdf`;
                    console.log("PDF generated, preparing share/download...");

                    // Check for Capacitor Native Plugins first
                    if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                        console.log("Running in Native Platform");
                        const { Share, Filesystem } = window.Capacitor.Plugins;

                        if (Share && Filesystem) {
                            try {
                                const pdfBase64 = doc.output('datauristring').split(',')[1];
                                const result = await Filesystem.writeFile({
                                    path: fileName,
                                    data: pdfBase64,
                                    directory: 'CACHE'
                                });
                                console.log("File written to cache: " + result.uri);

                                await Share.share({
                                    title: 'Fee Calculation Report',
                                    text: `Fee report for ${typeName}`,
                                    url: result.uri,
                                    dialogTitle: 'Share Report'
                                });
                                console.log("Native share triggered");
                                return;
                            } catch (err) {
                                console.error("Native share failed:", err);
                                // Continue to web fallback
                            }
                        }
                    }

                    // Web and Fallback Share Logic
                    console.log("Using Web/Browser download/share fallback");
                    const pdfBlob = doc.output('blob');
                    const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

                    // Try navigator.share first if available (mostly for mobile browsers)
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                        try {
                            await navigator.share({
                                files: [pdfFile],
                                title: 'Fee Calculation Report',
                                text: `Fee report for ${typeName}`
                            });
                            console.log("Navigator share successful");
                            return;
                        } catch (shareErr) {
                            console.log("Navigator share failed, falling back to download", shareErr);
                        }
                    }

                    // Final Fallback: Robust Download (Prevents about:blank/Untitled tabs)
                    console.log("Triggering robust download fallback");
                    const url = URL.createObjectURL(pdfBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Cleanup URL object after a short delay
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                } catch (err) {
                    console.error("Critical PDF failure:", err);
                    alert("Report Error: " + err.message);
                }
            });
        </script>

</body>

</html>