<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fee Calculator</title>
    <link rel="stylesheet" href="style.css">
    <!-- jsPDF Library in Head for faster loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Awesome for Home Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="fee.png">
    <link rel="apple-touch-icon" href="fee.png">
    <meta name="theme-color" content="#1a2a6c">
</head>

<body>
    <div class="container">
        <div class="top-nav">
            <a href="index.html" class="home-icon" title="Go to Home"><i class="fas fa-home"></i></a>
        </div>
        <h1>Fee Calculator</h1>

        <div class="form-group">
            <label for="installment-type">Select Type</label>
            <select id="installment-type">
                <option value="" disabled selected>Choose an option</option>
                <option value="first">First Installment</option>
                <option value="second">Second Installment</option>
                <option value="sslc-card">SSLC Card</option>
                <option value="sslc-fees">SSLC Fees</option>
                <option value="af-ff">AF/ff</option>
            </select>
        </div>

        <div id="first-installment-fields" class="hidden">
            <div class="form-group">
                <label>No of SC Students</label>
                <input type="number" id="sc-students" value="0">
            </div>
            <div class="form-group">
                <label>No of ST Students</label>
                <input type="number" id="st-students" value="0">
            </div>
            <div class="form-group">
                <label>No of OEC Students</label>
                <input type="number" id="oec-students" value="0">
            </div>
            <div class="form-group">
                <label>No of General Students</label>
                <input type="number" id="gen-students" value="0">
            </div>
            <div class="form-group">
                <label>Total No of Students</label>
                <input type="number" id="total-students" value="0">
            </div>

            <div id="calculation-result">
                <p id="fee-label">Total Fees</p>
                <div class="total-fee-val"><span id="currency-symbol">â‚¹</span> <span id="total-fee-amount">0.00</span>
                </div>
            </div>

            <button id="show-report" class="btn pdf-btn">Show Final Report</button>
            <button id="share-report" class="btn pdf-btn hidden">Share Report</button>

            <!-- Hidden Report for Printing and Preview -->
            <div id="report-preview">
                <div class="report-header-box">
                    <h2 id="report-school-name">GVHSS THRIKKOTHAMANGALAM</h2>
                </div>
                <div class="report-type-box">
                    <span id="rep-type-name"></span>
                </div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>No. of Students</th>
                            <th>Rate</th>
                            <th>Total Fee</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>SC</td>
                            <td id="rep-sc"></td>
                            <td>0.00</td>
                            <td id="rep-sc-fee"></td>
                        </tr>
                        <tr>
                            <td>ST</td>
                            <td id="rep-st"></td>
                            <td>0.00</td>
                            <td id="rep-st-fee"></td>
                        </tr>
                        <tr>
                            <td>OEC</td>
                            <td id="rep-oec"></td>
                            <td>0.00</td>
                            <td id="rep-oec-fee"></td>
                        </tr>
                        <tr>
                            <td>General</td>
                            <td id="rep-gen"></td>
                            <td>12.50</td>
                            <td id="rep-gen-fee"></td>
                        </tr>
                        <tr class="report-footer-row">
                            <td colspan="3" style="text-align: right;">Final Total Fees</td>
                            <td id="rep-fee" style="font-weight: bold;"></td>
                        </tr>
                    </tbody>
                </table>
                <div class="report-student-count">
                    Total No of Students: <span id="rep-total"></span>
                </div>
            </div>
        </div>

        <!-- Capacitor JavaScript (if running as an app) -->
        <script src="capacitor.js"></script>
        <script>
            const typeSelect = document.getElementById('installment-type');
            const firstFields = document.getElementById('first-installment-fields');
            const genStudentsInput = document.getElementById('gen-students');
            const totalFeeDisplay = document.getElementById('total-fee-amount');
            const showBtn = document.getElementById('show-report');
            const shareBtn = document.getElementById('share-report');
            const previewEl = document.getElementById('report-preview');
            const reportSchoolName = document.getElementById('report-school-name');

            // Load School Name
            const savedSchoolName = localStorage.getItem('schoolName') || 'GVHSS Thrikkothamangalam';
            document.title = `Fee Calculator - ${savedSchoolName}`;
            reportSchoolName.textContent = savedSchoolName.toUpperCase();

            // Show/Hide fields
            typeSelect.addEventListener('change', () => {
                if (typeSelect.value) {
                    firstFields.classList.remove('hidden');
                    // Reset all inputs to 0 on change
                    document.getElementById('total-students').value = "0";
                    document.getElementById('sc-students').value = "0";
                    document.getElementById('st-students').value = "0";
                    document.getElementById('oec-students').value = "0";
                    document.getElementById('gen-students').value = "0";
                } else {
                    firstFields.classList.add('hidden');
                }
                previewEl.style.display = 'none';
                shareBtn.classList.add('hidden');
                calculateFees();
            });

            // Calculate Fees
            const calculateFees = () => {
                const totalCountInput = document.getElementById('total-students');
                const scCountInput = document.getElementById('sc-students');
                const stCountInput = document.getElementById('st-students');
                const oecCountInput = document.getElementById('oec-students');
                const genCountInput = document.getElementById('gen-students');

                const totalCount = parseInt(totalCountInput.value) || 0;
                const scCount = parseInt(scCountInput.value) || 0;
                const stCount = parseInt(stCountInput.value) || 0;
                const oecCount = parseInt(oecCountInput.value) || 0;
                const genCount = parseInt(genCountInput.value) || 0;

                const sum = scCount + stCount + oecCount + genCount;
                const currencySymbol = document.getElementById('currency-symbol');
                const feeLabel = document.getElementById('fee-label');

                if (totalCount === 0) {
                    if (feeLabel) feeLabel.textContent = "Total Fees";
                    totalFeeDisplay.textContent = "0.00";
                    totalFeeDisplay.style.color = "";
                    totalFeeDisplay.style.fontSize = "";
                    if (currencySymbol) currencySymbol.style.display = "inline";
                    showBtn.disabled = true;
                    showBtn.style.cursor = "not-allowed";
                    showBtn.style.opacity = "0.6";
                    shareBtn.classList.add('hidden');
                } else if (sum !== totalCount) {
                    if (feeLabel) feeLabel.textContent = "Status";
                    totalFeeDisplay.textContent = "Mismatch in no. of students";
                    totalFeeDisplay.style.color = "#ff4d4d";
                    totalFeeDisplay.style.fontSize = "1.2rem";
                    if (currencySymbol) currencySymbol.style.display = "none";
                    showBtn.disabled = true;
                    showBtn.style.cursor = "not-allowed";
                    showBtn.style.opacity = "0.6";
                    shareBtn.classList.add('hidden');
                } else {
                    if (feeLabel) feeLabel.textContent = "Total Fees";

                    let fee = 0;
                    const type = typeSelect.value;

                    if (type === 'sslc-card') {
                        // General 15, SC/ST/OEC 0
                        fee = genCount * 15;
                    } else if (type === 'sslc-fees') {
                        // General 30, SC/ST/OEC 0
                        fee = genCount * 30;
                    } else if (type === 'af-ff') {
                        // General 17, OEC 17, SC/ST 0
                        fee = (genCount + oecCount) * 17;
                    } else {
                        // Default (Installments): General 12.5, SC/ST/OEC 0
                        fee = genCount * 12.5;
                    }

                    totalFeeDisplay.textContent = fee.toFixed(2);
                    totalFeeDisplay.style.color = "";
                    totalFeeDisplay.style.fontSize = "";
                    if (currencySymbol) currencySymbol.style.display = "inline";
                    showBtn.disabled = false;
                    showBtn.style.cursor = "pointer";
                    showBtn.style.opacity = "1";
                    shareBtn.classList.remove('hidden');
                }
            };

            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => input.addEventListener('input', calculateFees));

            // SHOW REPORT Logic
            showBtn.addEventListener('click', () => {
                const type = typeSelect.value;
                const reportTableBody = document.querySelector('#report-preview tbody');

                // Fill Preview Data
                document.getElementById('rep-type-name').textContent = typeSelect.options[typeSelect.selectedIndex].text;
                document.getElementById('rep-total').textContent = document.getElementById('total-students').value || "0";

                const scCount = parseFloat(document.getElementById('sc-students').value) || 0;
                const stCount = parseFloat(document.getElementById('st-students').value) || 0;
                const oecCount = parseFloat(document.getElementById('oec-students').value) || 0;
                const genCount = parseFloat(document.getElementById('gen-students').value) || 0;

                let scRate = 0, stRate = 0, oecRate = 0, genRate = 0;

                if (type === 'sslc-card') {
                    genRate = 15;
                } else if (type === 'sslc-fees') {
                    genRate = 30;
                } else if (type === 'af-ff') {
                    oecRate = 17;
                    genRate = 17;
                } else {
                    genRate = 12.5;
                }

                // Update Preview Rows
                const rows = reportTableBody.querySelectorAll('tr:not(.report-footer-row)');

                // SC Row
                rows[0].cells[2].textContent = scRate.toFixed(2);
                document.getElementById('rep-sc-fee').textContent = (scCount * scRate).toFixed(2);
                document.getElementById('rep-sc').textContent = scCount;

                // ST Row
                rows[1].cells[2].textContent = stRate.toFixed(2);
                document.getElementById('rep-st-fee').textContent = (stCount * stRate).toFixed(2);
                document.getElementById('rep-st').textContent = stCount;

                // OEC Row
                rows[2].cells[2].textContent = oecRate.toFixed(2);
                document.getElementById('rep-oec-fee').textContent = (oecCount * oecRate).toFixed(2);
                document.getElementById('rep-oec').textContent = oecCount;

                // Gen Row
                rows[3].cells[2].textContent = genRate.toFixed(2);
                document.getElementById('rep-gen-fee').textContent = (genCount * genRate).toFixed(2);
                document.getElementById('rep-gen').textContent = genCount;

                const totalFee = (scCount * scRate) + (stCount * stRate) + (oecCount * oecRate) + (genCount * genRate);
                document.getElementById('rep-fee').textContent = totalFee.toFixed(2);

                // Show Preview and Share button
                previewEl.style.display = 'block';
                shareBtn.classList.remove('hidden');
                previewEl.scrollIntoView({ behavior: 'smooth' });
            });

            // PDF Generation and Sharing
            shareBtn.addEventListener('click', async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const primaryColor = [26, 42, 108]; // Dark blue #1a2a6c

                    const type = typeSelect.value;
                    const typeName = typeSelect.options[typeSelect.selectedIndex].text;
                    const totalStudents = document.getElementById('total-students').value || "0";

                    const scCount = parseFloat(document.getElementById('sc-students').value) || 0;
                    const stCount = parseFloat(document.getElementById('st-students').value) || 0;
                    const oecCount = parseFloat(document.getElementById('oec-students').value) || 0;
                    const genCount = parseFloat(genStudentsInput.value) || 0;

                    let scRate = 0, stRate = 0, oecRate = 0, genRate = 0;

                    if (type === 'sslc-card') {
                        genRate = 15;
                    } else if (type === 'sslc-fees') {
                        genRate = 30;
                    } else if (type === 'af-ff') {
                        oecRate = 17;
                        genRate = 17;
                    } else {
                        genRate = 12.5;
                    }

                    // Header
                    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
                    doc.rect(0, 0, 210, 40, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont("helvetica", "bold");
                    const pdfSchoolName = (localStorage.getItem('schoolName') || 'GVHSS THRIKKOTHAMANGALAM').toUpperCase();
                    doc.text(pdfSchoolName, 105, 20, { align: "center" });
                    doc.setFontSize(14);
                    doc.text("FEE CALCULATION REPORT", 105, 30, { align: "center" });

                    // Report Details Section
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Type: ${typeName}`, 15, 55);
                    doc.text(`Date: ${new Date().toLocaleDateString()}`, 195, 55, { align: "right" });

                    // Table Data
                    const rows = [
                        ["SC", scCount, scRate.toFixed(2), (scCount * scRate).toFixed(2)],
                        ["ST", stCount, stRate.toFixed(2), (stCount * stRate).toFixed(2)],
                        ["OEC", oecCount, oecRate.toFixed(2), (oecCount * oecRate).toFixed(2)],
                        ["General", genCount, genRate.toFixed(2), (genCount * genRate).toFixed(2)]
                    ];

                    const totalFee = (scCount * scRate) + (stCount * stRate) + (oecCount * oecRate) + (genCount * genRate);

                    // Generate Table
                    doc.autoTable({
                        startY: 65,
                        head: [['Category', 'No. of Students', 'Rate (Rs.)', 'Total (Rs.)']],
                        body: rows,
                        foot: [['', '', 'Final Total Fee', `Rs. ${totalFee.toFixed(2)}`]],
                        theme: 'striped',
                        headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold', halign: 'center' },
                        footStyles: { fillColor: [240, 240, 240], textColor: 0, fontStyle: 'bold', halign: 'right' },
                        styles: { fontSize: 11, cellPadding: 5 },
                        columnStyles: {
                            1: { halign: 'right' },
                            2: { halign: 'right' },
                            3: { halign: 'right' }
                        }
                    });

                    // Student Count Summary moved under table
                    const finalY = doc.lastAutoTable.finalY + 15;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(`Total Number of Students: ${totalStudents}`, 15, finalY);

                    const fileName = `Fee_Report_${Date.now()}.pdf`;

                    // Check for Capacitor Native Plugins first
                    if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                        const { Share, Filesystem } = window.Capacitor.Plugins;

                        if (Share && Filesystem) {
                            try {
                                const pdfBase64 = doc.output('datauristring').split(',')[1];
                                const result = await Filesystem.writeFile({
                                    path: fileName,
                                    data: pdfBase64,
                                    directory: 'CACHE'
                                });

                                await Share.share({
                                    title: 'Fee Calculation Report',
                                    text: `Fee report for ${typeName}`,
                                    url: result.uri,
                                    dialogTitle: 'Share Report'
                                });
                                return;
                            } catch (err) {
                                console.error("Native share failed:", err);
                                // Continue to web fallback
                            }
                        } else {
                            console.warn("Capacitor plugins not available. Please install @capacitor/share and @capacitor/filesystem.");
                        }
                    }

                    // Web and Fallback Share Logic
                    const pdfBlob = doc.output('blob');
                    const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                        await navigator.share({
                            files: [pdfFile],
                            title: 'Fee Calculation Report',
                            text: `Fee report for ${typeName}`
                        });
                    } else {
                        // Fallback: This works better in most WebViews than window.print()
                        const pdfDataUri = doc.output('datauristring');
                        const newWindow = window.open(pdfDataUri, '_blank');
                        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                            // If popup blocked, use doc.save() or print
                            alert("Sharing not supported on this device. Please use Print to save as PDF.");
                            window.print();
                        }
                    }
                } catch (err) {
                    console.error("PDF generation/sharing failed:", err);
                    alert("An error occurred while generating the report. Please try again.");
                }
            });
        </script>

</body>

</html>